<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>YGSA 매칭 미리보기</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
      crossorigin
    />
    <style>
      :root {
        font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        --ink: #0f172a;
        --ink-subtle: #475569;
        --line: rgba(15, 23, 42, 0.08);
        --success: #0f9d58;
        --danger: #dc2626;
      }

      * {
        box-sizing: border-box;
      }

      [hidden] {
        display: none !important;
      }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--ink);
      }

      main.apply-layout {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: clamp(20px, 3vw, 32px);
        box-sizing: border-box;
        padding: 24px 16px;
      }

      .hero {
        display: grid;
        gap: 24px;
        width: 100%;
        max-width: 420px;
        text-align: left;
        color: #4f4f4f;
        justify-items: stretch;
      }

      .hero-description {
        margin: 0;
        line-height: 1.6;
        font-size: 18px;
        color: #7e7e7e;
      }

      .results {
        width: 100%;
        max-width: 1200px;
      }

      .hero-eyebrow {
        font-size: 13px;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        color: #a855f7;
        margin: 0;
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(28px, 6vw, 44px);
        line-height: 1.2;
      }

      form.lookup-form {
        display: grid;
        gap: 16px;
        max-width: 420px;
        width: 100%;
        margin: 0 auto;
        justify-items: stretch;
      }

      .input-group {
        display: grid;
        gap: 8px;
        width: 100%;
        justify-items: start;
      }

      label {
        font-weight: 600;
        color: #7e7e7e;
        font-size: 18px;
        text-align: left;
      }

      input[type='tel'] {
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px 18px;
        font-size: 16px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        width: 100%;
      }

      input[type='tel']:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.18);
      }

      button {
        border: none;
        border-radius: 16px;
        font-size: 16px;
        font-weight: 700;
        padding: 16px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        width: 100%;
      }

      button.primary {
        background: #5377f6;
        color: #fff;
        box-shadow: none;
      }

      button.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      button.primary:not(:disabled):hover {
        transform: translateY(-1px);
        background: #4c6fe0;
      }

      button.ghost {
        background: transparent;
        color: var(--ink-subtle);
        border: 1px solid rgba(148, 163, 184, 0.4);
      }

      .message {
        margin: 0;
        padding: 12px 14px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.5;
        display: none;
      }

      .message.is-visible {
        display: block;
      }

      .message.is-error {
        background: rgba(220, 38, 38, 0.08);
        color: var(--danger);
      }

      .message.is-success {
        background: rgba(16, 185, 129, 0.12);
        color: #0f9d58;
      }

      .results-head {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 24px;
      }

      .results-eyebrow {
        margin: 0;
        font-size: 16px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #5377f6;
        font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        font-weight: 500;
      }

      .results-head h2 {
        margin: 6px 0 4px;
        font-size: clamp(24px, 5vw, 36px);
        color: #4f4f4f;
        font-weight: 700;
      }

      .results-meta {
        margin: 0;
        color: #7e7e7e;
        font-size: 16px;
      }

      .matches-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
      }

      .match-card {
        position: relative;
        display: grid;
        gap: 18px;
        perspective: 1600px;
        overflow: visible;
      }

      .match-card-tagline {
        margin: 0;
        color: var(--ink-subtle);
        font-size: 14px;
        line-height: 1.6;
      }

      .profile-card-preview {
        width: 100%;
        aspect-ratio: 4 / 5;
        border-radius: 32px;
        border: 1px solid #f1f5f9;
        overflow: hidden;
        position: relative;
        background: linear-gradient(135deg, #f8fafc, #ffffff);
      }

      .profile-card-preview.profile-card-preview-female {
        border-color: #fecdd3;
        background: linear-gradient(135deg, #fff1f5, #ffe4e8);
      }

      .profile-card-preview.profile-card-preview-male {
        border-color: #bae6fd;
        background: linear-gradient(135deg, #ecfeff, #dbeafe);
      }

      .profile-card-slider {
        width: 100%;
        height: 100%;
        position: relative;
        opacity: 0;
        transform: rotateY(14deg) scale(0.96);
        filter: blur(4px) brightness(0.8);
        transition: opacity 500ms ease, transform 500ms ease, filter 500ms ease;
        visibility: hidden;
      }

      .match-card.is-open .profile-card-slider {
        opacity: 1;
        transform: rotateY(0deg) scale(1);
        filter: blur(0px) brightness(1);
        visibility: visible;
      }

      .match-card-cover {
        position: absolute;
        inset: 0;
        border-radius: 32px;
        background: radial-gradient(circle at top, rgba(83, 119, 246, 0.75), rgba(15, 23, 42, 0.95));
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 12px;
        cursor: pointer;
        z-index: 3;
        text-align: center;
        transition: opacity 350ms ease, transform 350ms ease;
        box-shadow: 0 20px 55px rgba(83, 119, 246, 0.4);
      }

      .match-card-cover span {
        font-size: 18px;
        font-weight: 600;
      }

      .match-card-cover small {
        font-size: 12px;
        letter-spacing: 0.2em;
        opacity: 0.8;
      }

      .match-card.is-open .match-card-cover {
        opacity: 0;
        pointer-events: none;
        transform: scale(1.05);
      }

      .match-card-flash {
        position: absolute;
        inset: 0;
        border-radius: 32px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0));
        opacity: 0;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      .match-card.is-open .match-card-flash {
        animation: cardFlash 650ms ease-out;
      }

      @keyframes cardFlash {
        0% {
          opacity: 0.9;
          transform: scale(0.95);
        }
        60% {
          opacity: 0.3;
        }
        100% {
          opacity: 0;
          transform: scale(1.15);
        }
      }

      .match-card-crack {
        position: absolute;
        inset: 0;
        border-radius: 32px;
        pointer-events: none;
        opacity: 0;
        mix-blend-mode: screen;
        background-image: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0) 55%),
          repeating-conic-gradient(
            from 0deg,
            rgba(255, 255, 255, 0.45) 0deg 6deg,
            transparent 6deg 18deg
          );
        filter: blur(1px);
      }

      .match-card.is-open .match-card-crack {
        animation: crackBurst 700ms ease-out forwards;
      }

      @keyframes crackBurst {
        0% {
          opacity: 0;
          transform: scale(0.8) rotate(-6deg);
          filter: blur(6px);
        }
        40% {
          opacity: 0.9;
        }
        100% {
          opacity: 0;
          transform: scale(1.25) rotate(4deg);
          filter: blur(1px);
        }
      }

      .match-card-sparks {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: visible;
      }

      .match-card-sparks span {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 18px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(83, 119, 246, 0));
        border-radius: 8px;
        transform-origin: center;
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.3);
        animation: sparkFly 720ms ease-out forwards;
        animation-delay: var(--delay, 0ms);
        animation-play-state: paused;
      }

      .match-card.is-open .match-card-sparks span {
        animation-play-state: running;
      }

      .match-card-actions {
        display: flex;
        justify-content: center;
        margin-top: 12px;
      }

      .match-card-select-btn {
        border: 1px solid #5377f6;
        border-radius: 999px;
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 600;
        background: #5377f6;
        color: #fff;
        cursor: pointer;
        box-shadow: none;
        transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
      }

      .match-card-select-btn:hover {
        transform: translateY(-1px);
        background: #4c6fe0;
        border-color: #4c6fe0;
      }

      .match-card-select-btn:focus-visible {
        outline: 3px solid rgba(83, 119, 246, 0.3);
        outline-offset: 3px;
      }

      .match-card-select-btn.is-completed {
        background: #e2e8f0;
        border-color: #e2e8f0;
        color: #6b7280;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .match-card-select-btn.is-completed:hover {
        transform: none;
        background: #e2e8f0;
        border-color: #e2e8f0;
      }

      .match-popup-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .match-popup {
        background: #fff;
        border-radius: 20px;
        padding: 28px 36px;
        box-shadow: 0 25px 60px rgba(15, 23, 42, 0.18);
        text-align: center;
        color: #4f4f4f;
        font-size: 18px;
        font-weight: 600;
      }

      @keyframes sparkFly {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.3);
        }
        20% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translate(
              calc(-50% + var(--sx, 0px)),
              calc(-50% + var(--sy, -80px))
            )
            scale(0.1)
            rotate(180deg);
        }
      }

      .profile-card-slide {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 0.35s ease;
        pointer-events: none;
      }

      .profile-card-slide.is-active {
        opacity: 1;
        pointer-events: auto;
      }

      .profile-card-slide-info {
        display: flex;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }

      .profile-card-info {
        width: 100%;
        padding: 32px;
        background: linear-gradient(135deg, #f8fafc, #ffffff);
        border-radius: 32px;
        display: flex;
        flex-direction: column;
        gap: 18px;
        color: #0f172a;
        height: 100%;
        flex: 1 0 auto;
      }

      .profile-card-info-label {
        font-size: 11px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: #94a3b8;
      }

      .profile-card-preview.profile-card-preview-female .profile-card-info {
        background: linear-gradient(135deg, #fff1f5, #ffe4e8);
        color: #8b1c3d;
      }

      .profile-card-preview.profile-card-preview-male .profile-card-info {
        background: linear-gradient(135deg, #ecfeff, #dbeafe);
        color: #0f4c81;
      }

      .profile-card-photo {
        position: relative;
        width: 100%;
        height: 100%;
        background: #020617;
      }

      .profile-card-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .profile-card-photo-label {
        position: absolute;
        bottom: 20px;
        left: 24px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.55);
        color: #f8fafc;
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .profile-card-slider-dots {
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 2;
      }

      .profile-card-slider-controls {
        position: absolute;
        bottom: 70px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 16px;
        z-index: 2;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      .profile-card-preview:hover .profile-card-slider-controls,
      .profile-card-preview:focus-within .profile-card-slider-controls {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .profile-card-slider-arrow {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 1px solid rgba(248, 250, 252, 0.6);
        background: rgba(15, 23, 42, 0.35);
        color: #f8fafc;
        font-size: 24px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .profile-card-slider-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.35);
        cursor: pointer;
        padding: 0;
      }

      .profile-card-slider-dot.is-active {
        background: #ffffff;
      }

      .profile-card-info h2 {
        display: none;
      }

      .profile-card-tagline {
        margin: 0;
        font-size: 14px;
        line-height: 1.6;
        color: #334155;
      }

      .profile-chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .profile-chip {
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        color: #0f172a;
      }

      .profile-chip.muted {
        color: #94a3b8;
        border-style: dashed;
      }

      .profile-card-preview-female .profile-chip {
        border-color: #fecdd3;
        background: rgba(244, 114, 182, 0.12);
        color: #be185d;
      }

      .profile-card-preview-male .profile-chip {
        border-color: #bae6fd;
        background: rgba(59, 130, 246, 0.12);
        color: #0f4c81;
      }

      .profile-card-stats {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .profile-card-stat {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 10px 12px;
        border-radius: 16px;
        background: rgba(248, 250, 252, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .profile-card-preview-female .profile-card-stat {
        background: rgba(244, 114, 182, 0.12);
        border-color: rgba(244, 114, 182, 0.45);
      }

      .profile-card-preview-male .profile-card-stat {
        background: rgba(59, 130, 246, 0.12);
        border-color: rgba(59, 130, 246, 0.45);
      }

      .profile-card-stat span {
        font-size: 10px;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: #a0aec0;
      }

      .profile-card-stat strong {
        font-size: 16px;
        color: #475569;
      }

      .profile-card-lifestyle {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .profile-card-lifestyle .label {
        font-size: 11px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: #94a3b8;
      }

      .profile-card-info-appeal {
        gap: 16px;
      }

      .profile-card-appeal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .profile-card-appeal-pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.12);
        font-size: 11px;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: #0f172a;
      }

      .profile-card-appeal-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .profile-card-appeal-block {
        padding: 0;
        border: none;
        border-radius: 0;
        background: transparent;
        width: 100%;
        text-align: left;
      }

      .profile-card-appeal-block + .profile-card-appeal-block {
        margin-top: 12px;
      }

      .profile-card-appeal-block .label {
        font-size: 11px;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: #94a3b8;
        text-align: left;
        display: block;
      }

      .profile-card-appeal-block p {
        margin: 8px 0 0;
        font-size: 14px;
        line-height: 1.6;
        color: #0f172a;
        white-space: pre-line;
        text-align: left;
      }

      .profile-card-appeal-empty {
        margin: 0;
        font-size: 14px;
        color: #94a3b8;
      }

      @media (max-width: 720px) {
        body {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>
    <main class="apply-layout">
      <section class="hero">
        <div>
          <h1 style="margin:0 0 12px 0;font-size:36px;font-weight:700;color:#4f4f4f;">
            매칭 확인하기<span style="color:#5377f6;">.</span>
          </h1>
          <p class="hero-description">
            라운드 기준으로 가까운 수요일에 공개됩니다.<br />
            기본 3명, 상황에 따라 추가 제안이 열릴 수 있어요.
          </p>
        </div>
        <form id="lookupForm" class="lookup-form" novalidate>
          <div class="input-group">
            <label for="phoneInput" style="font-weight:400;color:#7e7e7e;font-size:18px;text-align:left;">
              상담 시 등록했던 휴대폰 번호를 입력해주세요
            </label>
            <input
              id="phoneInput"
              type="tel"
              inputmode="tel"
              autocomplete="tel"
              placeholder="예: 010-1111-1111"
              required
            />
          </div>
          <button type="submit" id="submitButton" class="primary">추천 카드 보기</button>
          <p id="formMessage" class="message" role="alert"></p>
        </form>
      </section>
      <section class="results" id="resultsSection" hidden>
        <div class="results-head">
          <div>
            <p class="results-eyebrow" id="weekLabel">이번 주 추천</p>
            <h2 id="resultTitle">회원님을 위한 추천</h2>
            <p class="results-meta" id="resultMeta"></p>
          </div>
        </div>
        <div class="matches-grid" id="matchCards"></div>
      </section>
    </main>
    <script>
      window.BACKEND_ORIGIN = window.BACKEND_ORIGIN || 'https://ygsa-backend.onrender.com'
    </script>
    <script src="https://ygsa-backend.onrender.com/backend-config.js"></script>
    <script>
      ;(() => {
        const canvas = document.createElement('canvas')
        canvas.id = 'confettiCanvas'
        canvas.style.position = 'fixed'
        canvas.style.top = '0'
        canvas.style.left = '0'
        canvas.style.width = '100%'
        canvas.style.height = '100%'
        canvas.style.pointerEvents = 'none'
        canvas.style.zIndex = '9999'
        document.body.appendChild(canvas)

        const ctx = canvas.getContext('2d')
        const resize = () => {
          canvas.width = window.innerWidth
          canvas.height = window.innerHeight
        }
        resize()
        window.addEventListener('resize', resize)

        const colors = ['#ff6b6b', '#ffd93d', '#6bcbee', '#a26bff', '#4ade80']
        const particles = []
        const gravity = 0.12
        const drag = 0.98

        const createBurst = () => {
          const count = 160
          for (let i = 0; i < count; i += 1) {
            const angle = (Math.PI * 2 * i) / count + Math.random() * 0.3
            const speed = Math.random() * 8 + 4
            particles.push({
              x: canvas.width / 2,
              y: canvas.height * 0.35,
              vx: Math.cos(angle) * speed,
              vy: Math.sin(angle) * speed - 2,
              size: Math.random() * 6 + 4,
              color: colors[Math.floor(Math.random() * colors.length)],
              rotation: Math.random() * Math.PI,
              rotationSpeed: (Math.random() - 0.5) * 0.2,
              life: 1,
            })
          }
        }

        let animationFrame
        const render = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height)
          particles.forEach((p) => {
            p.vx *= drag
            p.vy = p.vy * drag + gravity
            p.x += p.vx
            p.y += p.vy
            p.rotation += p.rotationSpeed
            p.life -= 0.005

            ctx.save()
            ctx.translate(p.x, p.y)
            ctx.rotate(p.rotation)
            ctx.globalAlpha = Math.max(p.life, 0)
            ctx.fillStyle = p.color
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 1.4)
            ctx.restore()
          })
          for (let i = particles.length - 1; i >= 0; i -= 1) {
            if (particles[i].life <= 0 || particles[i].y > canvas.height + 50) {
              particles.splice(i, 1)
            }
          }
          if (particles.length) {
            animationFrame = requestAnimationFrame(render)
          }
        }

        window.addEventListener('load', () => {
          createBurst()
          render()
          setTimeout(() => {
            cancelAnimationFrame(animationFrame)
            window.removeEventListener('resize', resize)
            canvas.remove()
          }, 3500)
        })
      })()
    </script>
    <script>
      ;(() => {
        const form = document.getElementById('lookupForm')
        const heroSection = document.querySelector('.hero')
        const phoneInput = document.getElementById('phoneInput')
        const submitButton = document.getElementById('submitButton')
        const messageEl = document.getElementById('formMessage')
        const resultsSection = document.getElementById('resultsSection')
        const resultTitle = document.getElementById('resultTitle')
        const resultMeta = document.getElementById('resultMeta')
        const weekLabel = document.getElementById('weekLabel')
        const matchCards = document.getElementById('matchCards')
        const MATCH_MANAGER_URL =
          (window.MATCH_MANAGER_URL && String(window.MATCH_MANAGER_URL).trim()) || ''
        let currentTargetProfile = null
        let matchPopupTimer = null
        let lastLookupPhoneKey = ''
        const matchedCandidateIds = new Set()

        const resolvedOrigin =
          (typeof window !== 'undefined' && window.BACKEND_ORIGIN) ||
          (typeof location !== 'undefined' ? `${location.origin}` : '')
        const MATCH_LOOKUP_URL = `${(resolvedOrigin || '').replace(/\/$/, '') || ''}/api/match-history/lookup`

        form?.addEventListener('submit', handleSubmit)

        async function handleSubmit(event) {
          event.preventDefault()
          if (!phoneInput) return
          const phone = phoneInput.value.replace(/[^0-9]/g, '').trim()
          if (!phone) {
            showMessage('전화번호를 입력해주세요.', true)
            return
          }
          lastLookupPhoneKey = phone
          setLoading(true)
          showMessage('')
          try {
            const payload = await fetchMatches(phone)
            renderMatches(payload)
            showMessage('')
          } catch (error) {
            console.error(error)
            showMessage(error?.message || '매칭 정보를 불러오지 못했습니다.', true)
            resultsSection.hidden = true
          } finally {
            setLoading(false)
          }
        }

        function setLoading(isLoading) {
          if (submitButton) {
            submitButton.disabled = Boolean(isLoading)
            submitButton.textContent = isLoading ? '불러오는 중...' : '추천 카드 보기'
          }
        }
        if (phoneInput) {
          phoneInput.addEventListener('input', () => {
            let digits = phoneInput.value.replace(/[^0-9]/g, '')
            if (digits.length < 4) {
              phoneInput.value = digits
              return
            }
            if (digits.length < 8) {
              phoneInput.value = digits.replace(/(\d{3})(\d+)/, '$1-$2')
              return
            }
            phoneInput.value = digits.replace(/(\d{3})(\d{3,4})(\d{0,4}).*/, '$1-$2-$3')
          })
        }

        async function fetchMatches(phone) {
          const response = await fetch(MATCH_LOOKUP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, limit: 3 }),
            cache: 'no-store',
          })
          let body = {}
          try {
            body = await response.json()
          } catch (_) {
            /* noop */
          }
          if (!response.ok || body?.ok === false) {
            const message = body?.message || '조회에 실패했습니다.'
            throw new Error(message)
          }
          return body?.data || {}
        }

        function renderMatches(data) {
          const matches = Array.isArray(data?.matches) ? data.matches : []
          if (!matches.length) {
            resultsSection.hidden = true
            throw new Error('표시할 매칭 카드가 없습니다.')
          }
          syncMatchedCandidateIds(Array.isArray(data?.matchedCandidateIds) ? data.matchedCandidateIds : [])
          const targetName = data?.target?.name || '회원님'
          const nameWithHonorific = targetName.endsWith('님') ? targetName : `${targetName}님`
          resultTitle.textContent = `${nameWithHonorific}을 위한 추천`
          resultMeta.textContent = data?.target?.phoneMasked
            ? `${data.target.phoneMasked} 인증 완료`
            : ''
          weekLabel.textContent = data?.week?.label || '이번 주 추천'
          currentTargetProfile = buildMatchTargetSnapshot(data?.target)

          matchCards.innerHTML = ''
          matches.forEach((record, index) => {
            const card = renderMatchCard(record, index + 1)
            if (card) {
              matchCards.appendChild(card)
            }
          })
          if (heroSection) {
            heroSection.hidden = true
          }
          resultsSection.hidden = false
        }

        function syncMatchedCandidateIds(ids = []) {
          matchedCandidateIds.clear()
          ids
            .map((value) => (value == null ? '' : String(value).trim()))
            .filter(Boolean)
            .forEach((id) => matchedCandidateIds.add(id))
        }

        function renderMatchCard(record, order) {
          if (!record) return null
          const wrapper = document.createElement('article')
          wrapper.className = 'match-card'
          wrapper.tabIndex = 0
          const candidateId = getCandidateIdentifier(record)
          const matchEntryId = record.matchEntryId || ''
          const preview = document.createElement('div')
          const toneClass = getProfileToneClass(record.gender)
          preview.className = `profile-card-preview ${toneClass}`.trim()
          preview.innerHTML = renderProfileCard(record)
          const cover = document.createElement('div')
          cover.className = 'match-card-cover'
          cover.innerHTML = `
            <span>매칭 ${order || ''}</span>
            <small>카드를 펼쳐 확인하세요</small>
          `
          const flash = document.createElement('div')
          flash.className = 'match-card-flash'
          const crack = document.createElement('div')
          crack.className = 'match-card-crack'
          const sparks = document.createElement('div')
          sparks.className = 'match-card-sparks'
          const sparkCount = 10
          for (let i = 0; i < sparkCount; i += 1) {
            const span = document.createElement('span')
            const angle = (Math.PI * 2 * i) / sparkCount + Math.random() * 0.3
            const distance = 140 + Math.random() * 60
            span.style.setProperty('--sx', `${Math.cos(angle) * distance}px`)
            span.style.setProperty('--sy', `${Math.sin(angle) * distance}px`)
            span.style.setProperty('--delay', `${i * 35}ms`)
            span.style.transform = `rotate(${(angle * 180) / Math.PI}deg)`
            sparks.appendChild(span)
          }
          preview.appendChild(cover)
          preview.appendChild(flash)
          preview.appendChild(crack)
          preview.appendChild(sparks)
          wrapper.appendChild(preview)
          const actions = document.createElement('div')
          actions.className = 'match-card-actions'
          const actionButton = createMatchSelectButton(record, candidateId, matchEntryId)
          actions.appendChild(actionButton)
          preview.insertAdjacentElement('afterend', actions)
          initProfileCardSlider(preview)
          applyMatchedCardState(wrapper, actionButton, candidateId, record.matchCategory)
          setupCardReveal(wrapper)
          return wrapper
        }
        function applyMatchedCardState(wrapper, button, candidateId, category) {
          if (!wrapper || !button) return
          const candidateKey = candidateId ? String(candidateId) : ''
          const normalizedCategory = String(category || '').trim().toLowerCase()
          const alreadyMatched =
            normalizedCategory === 'confirmed' || (candidateKey && matchedCandidateIds.has(candidateKey))
          if (!alreadyMatched) return
          markMatchButtonCompleted(button)
          wrapper.classList.add('is-open')
          const cover = wrapper.querySelector('.match-card-cover')
          if (cover) {
            cover.style.opacity = '0'
            cover.style.pointerEvents = 'none'
          }
        }


        function showMessage(text, isError = false) {
          if (!messageEl) return
          if (!text) {
            messageEl.textContent = ''
            messageEl.classList.remove('is-visible', 'is-error', 'is-success')
            return
          }
          messageEl.textContent = text
          messageEl.classList.add('is-visible')
          messageEl.classList.toggle('is-error', Boolean(isError))
          messageEl.classList.toggle('is-success', !isError)
        }

        function getProfileToneClass(gender) {
          if (!gender) return ''
          const normalized = String(gender).trim()
          if (/여|female|woman/i.test(normalized)) return 'profile-card-preview-female'
          if (/남|male|man/i.test(normalized)) return 'profile-card-preview-male'
          return ''
        }

        const PROFILE_CARD_CHARACTER_NAMES = [
          '루나',
          '카이',
          '아린',
          '라온',
          '세라',
          '레온',
          '이든',
          '소라',
          '리안',
          '제이드',
          '하린',
          '도윤',
          '미카',
          '유나',
          '지안',
          '네로',
          '하루',
          '라일라',
          '준호',
          '세이',
        ]

        const SALARY_RANGE_LABELS = {
          '1': '3000만원 미만',
          '2': '3000-4000만원',
          '3': '4000-6000만원',
          '4': '6000-8000만원',
          '5': '8000-1억원',
          '6': '1-2억원',
          '7': '2-3억원',
          '8': '3억원 이상',
        }

        const profileCardNameCache = new WeakMap()

        function renderProfileCard(record) {
          const slides = buildProfileCardSlides(record)
          const slideCount = slides.length || 1
          return `
            <div class="profile-card-slider" data-profile-card-slider data-slide-count="${slideCount}">
              ${slides
                .map(
                  (slide, index) => `
                  <div class="profile-card-slide ${slide.className} ${index === 0 ? 'is-active' : ''}" data-profile-card-slide data-slide-index="${index}">
                    ${slide.content}
                  </div>
                `,
                )
                .join('')}
              ${slideCount > 1 ? renderProfileCardSliderExtras(slideCount) : ''}
            </div>
          `
        }

        function buildProfileCardSlides(record) {
          const slides = []
          const facePhotos = getProfileCardPhotos(record, 'face')
          facePhotos.forEach((photo, index) => {
            slides.push({
              className: 'profile-card-slide-photo',
              content: renderProfileCardPhotoSlide(photo, `얼굴 사진 ${index + 1}`),
            })
          })
          const fullPhotos = getProfileCardPhotos(record, 'full')
          fullPhotos.forEach((photo, index) => {
            slides.push({
              className: 'profile-card-slide-photo',
              content: renderProfileCardPhotoSlide(photo, `전신 사진 ${index + 1}`),
            })
          })
          const infoContent = renderProfileCardInfoSection(record)
          if (infoContent) {
            slides.push({ className: 'profile-card-slide-info', content: infoContent })
          }
          const appealContent = renderProfileCardAppealSection(record)
          if (appealContent) {
            slides.push({
              className: 'profile-card-slide-info profile-card-slide-appeal',
              content: appealContent,
            })
          }
          return slides
        }

        function renderProfileCardSliderExtras(count) {
          return `
            <div class="profile-card-slider-controls" role="group" aria-label="슬라이드 제어">
              <button type="button" class="profile-card-slider-arrow profile-card-slider-arrow-prev" data-slide-action="prev" aria-label="이전 슬라이드">‹</button>
              <button type="button" class="profile-card-slider-arrow profile-card-slider-arrow-next" data-slide-action="next" aria-label="다음 슬라이드">›</button>
            </div>
            <div class="profile-card-slider-dots" data-profile-card-dots role="tablist">
              ${Array.from({ length: count })
                .map(
                  (_, index) => `
                  <button type="button" class="profile-card-slider-dot ${index === 0 ? 'is-active' : ''}" data-slide-to="${index}" aria-label="${index + 1}번째 슬라이드 보기"></button>
                `,
                )
                .join('')}
            </div>
          `
        }

        function renderProfileCardPhotoSlide(photo, fallbackLabel) {
          if (!photo?.source) return ''
          const label = fallbackLabel || photo.label || '프로필 사진'
          return `
            <div class="profile-card-photo">
              <img src="${escapeHtml(photo.source)}" alt="${escapeHtml(label)}" loading="lazy" />
              <span class="profile-card-photo-label">${escapeHtml(label)}</span>
            </div>
          `
        }

        function createMatchSelectButton(record, candidateId, matchEntryId) {
          const button = document.createElement('button')
          button.type = 'button'
          button.className = 'match-card-select-btn'
          button.textContent = '매칭 선택하기'
          const targetReady = currentTargetProfile && currentTargetProfile.id
          const candidateKey = candidateId ? String(candidateId) : ''
          if (!targetReady || !candidateKey) {
            button.disabled = true
            button.title = '추천 대상 정보를 찾을 수 없습니다.'
          }
          button.addEventListener('click', (event) => {
            event.stopPropagation()
            handleCardMatchSelect(record, button, candidateId, matchEntryId)
          })
          return button
        }

        async function handleCardMatchSelect(record, button, candidateIdOverride, matchEntryId) {
          const originalScrollY = window.scrollY || document.documentElement.scrollTop || 0
          const originalButtonTop = button?.getBoundingClientRect()?.top || 0
          const candidateId = candidateIdOverride || getCandidateIdentifier(record)
          const payload = buildMatchSelectionPayload(record, candidateId, matchEntryId)
          if (!payload) {
            showMessage('매칭 정보를 준비할 수 없습니다. 관리자에게 문의해주세요.', true)
            return
          }
          try {
            await sendMatchRequest(payload)
            markMatchButtonCompleted(button)
            if (candidateId) {
              matchedCandidateIds.add(String(candidateId))
            }
            showMatchConfirmationPopup()
            window.requestAnimationFrame(() => {
              window.scrollTo(0, originalScrollY)
              const newButtonTop = button?.getBoundingClientRect()?.top || originalButtonTop
              const delta = newButtonTop - originalButtonTop
              if (Math.abs(delta) > 1) {
                window.scrollBy(0, delta)
              }
            })
          } catch (error) {
            console.error('[match-select] 전송 실패', error)
            showMessage(error?.message || '매칭 신청을 전송하지 못했습니다.', true)
          }
        }

        function buildMatchSelectionPayload(record, candidateIdArg, matchEntryId) {
          if (!record || !currentTargetProfile || !lastLookupPhoneKey) return null
          const candidateId = candidateIdArg || getCandidateIdentifier(record)
          const targetId = currentTargetProfile.id || ''
          if (!candidateId || !targetId) return null
          const matchedAt =
            typeof record.matchRecordedAt === 'number' && record.matchRecordedAt > 0
              ? record.matchRecordedAt
              : Date.now()
          const candidatePhone = normalizePhoneKey(record.phone || record.phoneNumber || '')
          const candidateName = record.name || record.characterName || '추천 후보'
          const candidateGender = record.gender || ''
          const targetName = currentTargetProfile.name || '회원님'
          const targetGender = currentTargetProfile.gender || ''
          return {
            id: matchEntryId || `${targetId}-${candidateId}-${matchedAt}`,
            candidateId,
            targetId,
            targetPhone: lastLookupPhoneKey,
            matchedAt,
            week: buildWeekMeta(new Date(matchedAt)),
            category: 'confirmed',
            candidateName,
            candidateGender,
            candidatePhone,
            targetName,
            targetGender,
          }
        }

        async function sendMatchRequest(payload) {
          const endpoint =
            (MATCH_MANAGER_URL && MATCH_MANAGER_URL.trim()) ||
            `${(resolvedOrigin || '').replace(/\/$/, '') || ''}/api/match-history`
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
            mode: 'cors',
          })
          if (!response.ok) {
            const message = await response
              .json()
              .then((body) => body?.message)
              .catch(() => '')
            throw new Error(message || '매칭 기록을 저장하지 못했습니다.')
          }
        }

        function getCandidateIdentifier(record) {
          return (
            record.id ||
            record.uuid ||
            record.candidateId ||
            record.profileId ||
            record.phone ||
            record.key ||
            ''
          )
        }

        function buildMatchTargetSnapshot(target) {
          if (!target) return null
          const phone = target.phone || target.phoneNumber || ''
          return {
            id: target.id || target.uuid || '',
            name: target.name || '회원님',
            gender: target.gender || '',
            phone,
            phoneMasked: target.phoneMasked || '',
            job: target.job || '',
            height: normalizeHeightValue(target.height) || '',
          }
        }


        function markMatchButtonCompleted(button) {
          if (!button) return
          button.disabled = true
          button.classList.add('is-completed')
          button.textContent = '매칭이 신청되었습니다'
        }

        function showMatchConfirmationPopup() {
          let overlay = document.getElementById('matchSelectionPopup')
          if (!overlay) {
            overlay = document.createElement('div')
            overlay.id = 'matchSelectionPopup'
            overlay.className = 'match-popup-overlay'
            const popup = document.createElement('div')
            popup.className = 'match-popup'
            popup.textContent = '매칭이 신청되었습니다!'
            overlay.appendChild(popup)
            overlay.addEventListener('click', hideMatchConfirmationPopup)
            document.body.appendChild(overlay)
          } else {
            overlay.querySelector('.match-popup').textContent = '매칭이 신청되었습니다!'
          }
          overlay.hidden = false
          if (matchPopupTimer) {
            window.clearTimeout(matchPopupTimer)
          }
          matchPopupTimer = window.setTimeout(hideMatchConfirmationPopup, 1800)
        }

        function hideMatchConfirmationPopup() {
          const overlay = document.getElementById('matchSelectionPopup')
          if (!overlay) return
          overlay.hidden = true
          if (matchPopupTimer) {
            window.clearTimeout(matchPopupTimer)
            matchPopupTimer = null
          }
        }

        function buildWeekMeta(date) {
          const info = getWeekInfo(date)
          return {
            label: info.label,
            startTime: info.start.getTime(),
            endTime: info.end.getTime(),
            year: info.year,
            week: info.week,
          }
        }

        function getWeekInfo(date) {
          const target = new Date(date)
          const day = target.getDay() || 7
          const start = new Date(target)
          start.setHours(0, 0, 0, 0)
          start.setDate(start.getDate() - (day - 1))
          const end = new Date(start)
          end.setDate(start.getDate() + 6)

          const utcDate = new Date(Date.UTC(target.getFullYear(), target.getMonth(), target.getDate()))
          const utcDay = utcDate.getUTCDay() || 7
          utcDate.setUTCDate(utcDate.getUTCDate() + 4 - utcDay)
          const isoYear = utcDate.getUTCFullYear()
          const yearStart = new Date(Date.UTC(isoYear, 0, 1))
          const weekNo = Math.ceil(((utcDate - yearStart) / 86400000 + 1) / 7)

          return {
            year: isoYear,
            week: weekNo,
            label: `${isoYear}년 ${String(weekNo).padStart(2, '0')}주차`,
            start,
            end,
          }
        }

        function renderProfileCardInfoSection(record) {
          if (!record) return ''
          const chips =
            getProfileCardChips(record)
              .map((chip) => `<span class="profile-chip">${escapeHtml(chip)}</span>`)
              .join('') || '<span class="profile-chip muted">정보 준비 중</span>'
          const stats =
            getProfileCardStats(record)
              .map(
                ({ label, value }) => `
                  <div class="profile-card-stat">
                    <span>${escapeHtml(label)}</span>
                    <strong>${escapeHtml(value || '-')}</strong>
                  </div>
                `,
              )
              .join('') || `
              <div class="profile-card-stat">
                <span>INFO</span>
                <strong>업데이트 예정</strong>
              </div>
            `
          const lifestyle =
            getProfileCardLifestyle(record)
              .map((item) => `<span class="profile-chip">${escapeHtml(item)}</span>`)
              .join('') || '<span class="profile-chip muted">라이프스타일 업데이트 예정</span>'
          return `
            <div class="profile-card-info">
              <span class="profile-card-info-label">회원 정보</span>
              <h2>${escapeHtml(getProfileCardDisplayName(record))}</h2>
              <p class="profile-card-tagline">${escapeHtml(getProfileCardTagline(record))}</p>
              <div class="profile-chip-row">${chips}</div>
              <div class="profile-card-stats">${stats}</div>
              <div class="profile-card-lifestyle">
                <span class="label">선호 라이프스타일</span>
                <div class="profile-chip-row">${lifestyle}</div>
              </div>
            </div>
          `
        }

        function renderProfileCardAppealSection(record) {
          const blocks = getProfileCardAppealBlocks(record)
          const body =
            blocks.length > 0
              ? blocks
                  .map(
                    ({ label, value }) => `
                <section class="profile-card-appeal-block">
                  <span class="label">${escapeHtml(label)}</span>
                  <p>${formatProfileCardAppealValue(value)}</p>
                </section>
              `,
                  )
                  .join('')
              : `<p class="profile-card-appeal-empty">추가 어필 정보가 준비 중입니다.</p>`
          return `
            <div class="profile-card-info profile-card-info-appeal">
              <div class="profile-card-appeal-header">
                <span class="profile-card-info-label">추가 어필</span>
                <span class="profile-card-appeal-pill">연결사 추천</span>
              </div>
              <div class="profile-card-appeal-body">
                ${body}
              </div>
            </div>
          `
        }

        function getProfileCardDisplayName(record) {
          if (!record || typeof record !== 'object') return '연결사 회원'
          if (record.characterName) return record.characterName
          if (profileCardNameCache.has(record)) {
            return profileCardNameCache.get(record)
          }
          const seedSource =
            record.id ||
            record.uuid ||
            record.key ||
            record.phoneNumber ||
            record.phone ||
            record.email ||
            record.createdAt
          const alias = getRandomProfileCardName(seedSource)
          profileCardNameCache.set(record, alias)
          return alias
        }

        function getRandomProfileCardName(seedSource) {
          const pool = Array.isArray(PROFILE_CARD_CHARACTER_NAMES)
            ? PROFILE_CARD_CHARACTER_NAMES
            : []
          if (!pool.length) return '연결사 회원'
          if (seedSource !== undefined && seedSource !== null) {
            const seedString = String(seedSource).trim()
            if (seedString) {
              const hash = seedString.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)
              return pool[hash % pool.length]
            }
          }
          const randomIndex = Math.floor(Math.random() * pool.length)
          return pool[randomIndex]
        }

        function getProfileCardTagline(record) {
          if (record?.profileAppeal) return record.profileAppeal
          if (record?.aboutMe) return record.aboutMe
          if (record?.sufficientCondition) return record.sufficientCondition
          return '연결사가 엄선한 프리미엄 인연'
        }

        function getProfileCardAppealBlocks(record) {
          if (!record) return []
          const blocks = []
          const addBlock = (label, value) => {
            const text = typeof value === 'string' ? value.trim() : ''
            if (!text) return
            blocks.push({ label, value: text })
          }
          if (record.profileAppeal || record.aboutMe || record.sufficientCondition) {
            addBlock('대표 어필', getProfileCardTagline(record))
          }
          addBlock('충분 조건', record.sufficientCondition)
          addBlock('필수 조건', record.necessaryCondition)
          addBlock('선호 / 비선호', record.likesDislikes)
          const values = Array.isArray(record.values) ? record.values.filter(Boolean) : []
          if (values.length) {
            addBlock('가치관', values.join(' · '))
          }
          addBlock('가치관 (기타)', record.valuesCustom)
          addBlock('자기 소개', record.aboutMe)
          addBlock('노트', record.notes)
          return blocks
        }

        function formatProfileCardAppealValue(value) {
          const safe = typeof value === 'string' ? value : String(value || '')
          return escapeHtml(safe).replace(/\n/g, '<br />')
        }

        function getProfileCardChips(record) {
          const chips = []
          if (record?.job) chips.push(record.job)
          if (record?.education) chips.push(record.education)
          if (record?.district) chips.push(record.district)
          if (record?.university) chips.push(record.university)
          return chips.slice(0, 3)
        }

        function getProfileCardStats(record) {
          if (!record) return []
          const stats = [
            { label: 'BIRTH', value: formatProfileBirthLabel(record.birth) },
            { label: 'HEIGHT', value: normalizeHeightValue(record.height || record.region) || '-' },
            { label: 'CAREER', value: record.job || '-' },
            { label: 'MBTI', value: (record.mbti || '-').toUpperCase() },
          ]
          const salaryLabel = formatSalaryRange(record.salaryRange)
          if (salaryLabel) {
            stats.push({ label: 'SALARY', value: salaryLabel })
          } else if (record.education) {
            stats.push({ label: 'EDU', value: record.education })
          }
          return stats
        }

        function getProfileCardLifestyle(record) {
          if (!record) return []
          const preferred = Array.isArray(record.preferredLifestyle)
            ? record.preferredLifestyle.filter(Boolean)
            : []
          if (preferred.length) {
            return preferred.slice(0, 3)
          }
          if (record.likesDislikes) {
            return record.likesDislikes
              .split(/[,·]/)
              .map((value) => value.trim())
              .filter(Boolean)
              .slice(0, 3)
          }
          return []
        }

        function formatProfileBirthLabel(value) {
          const digits = String(value || '').replace(/[^0-9]/g, '')
          if (digits.length >= 4) {
            return `${digits.slice(0, 4)}`
          }
          return value || '-'
        }

        function normalizeHeightValue(raw) {
          const digits = String(raw || '').replace(/[^0-9]/g, '').slice(0, 3)
          return digits ? `${digits}cm` : ''
        }

        function normalizePhoneKey(value) {
          return String(value || '').replace(/[^0-9]/g, '')
        }

        function formatSalaryRange(value) {
          return SALARY_RANGE_LABELS[value] || ''
        }

        function getProfileCardPhotos(record, preferredType) {
          if (!record) return []
          const normalized = preferredType === 'full' ? 'full' : 'face'
          const photos = Array.isArray(record.photos) ? record.photos : []
          const seen = new Set()
          return photos
            .map((photo) => {
              const role = getProfilePhotoRole(photo)
              if (!isProfilePhotoRoleMatch(role, normalized)) return null
              const source = getFileSource(photo)
              if (!source || seen.has(source)) return null
              seen.add(source)
              return { source, label: photo.name || '' }
            })
            .filter(Boolean)
        }

        function getProfilePhotoRole(photo) {
          const meta = photo?.meta || {}
          return String(
            photo?.role || meta.type || meta.category || meta.tag || meta.label || '',
          )
            .trim()
            .toLowerCase()
        }

        function isProfilePhotoRoleMatch(role, preferredType) {
          if (!role) return false
          if (preferredType === 'full') {
            return /full|body|전신/.test(role)
          }
          return /face|프로필|상반|portrait/.test(role)
        }

        function initProfileCardSlider(previewEl) {
          if (!previewEl) return
          const slider = previewEl.querySelector('[data-profile-card-slider]')
          if (!slider || slider.dataset.initialized === 'true') return
          slider.dataset.initialized = 'true'
          slider.dataset.currentIndex = '0'
          slider.tabIndex = 0
          slider.addEventListener('click', handleProfileCardSliderClick)
          slider.addEventListener('keydown', handleProfileCardSliderKeydown)
        }

        function setupCardReveal(card) {
          if (!card) return
          const cover = card.querySelector('.match-card-cover')
          const openCard = () => {
            if (card.classList.contains('is-open')) return
            card.classList.add('is-open')
          }
          if (cover) {
            cover.addEventListener('click', (event) => {
              event.stopPropagation()
              openCard()
            })
          }
          card.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault()
              openCard()
            }
          })
        }

        function handleProfileCardSliderClick(event) {
          const slider = event.currentTarget
          const dot = event.target.closest('[data-slide-to]')
          if (dot) {
            event.stopPropagation()
            setProfileCardSliderIndex(slider, Number(dot.dataset.slideTo || 0))
            return
          }
          const arrow = event.target.closest('[data-slide-action]')
          if (arrow) {
            event.stopPropagation()
            const action = arrow.dataset.slideAction
            advanceProfileCardSlider(slider, action === 'prev' ? -1 : 1)
            return
          }
          const interactive = event.target.closest('button, a')
          if (interactive && !interactive.dataset.slideTo && !interactive.dataset.slideAction) return
          const rect = slider.getBoundingClientRect?.()
          if (rect && Number.isFinite(rect.width) && rect.width > 0) {
            const clickX = event.clientX ?? rect.left
            const relativeX = clickX - rect.left
            const goPrev = relativeX < rect.width / 2
            advanceProfileCardSlider(slider, goPrev ? -1 : 1)
          } else {
            advanceProfileCardSlider(slider)
          }
        }

        function handleProfileCardSliderKeydown(event) {
          if (event.key === 'ArrowRight') {
            event.preventDefault()
            advanceProfileCardSlider(event.currentTarget, 1)
            return
          }
          if (event.key === 'ArrowLeft') {
            event.preventDefault()
            advanceProfileCardSlider(event.currentTarget, -1)
            return
          }
          if (event.key === ' ' || event.key === 'Enter') {
            event.preventDefault()
            advanceProfileCardSlider(event.currentTarget, 1)
          }
        }

        function advanceProfileCardSlider(slider, step = 1) {
          if (!slider) return
          const slides = slider.querySelectorAll('[data-profile-card-slide]')
          const count = slides.length
          if (!count) return
          const current = Number(slider.dataset.currentIndex || 0)
          const next = (current + step + count) % count
          setProfileCardSliderIndex(slider, next)
        }

        function setProfileCardSliderIndex(slider, index) {
          if (!slider) return
          const slides = slider.querySelectorAll('[data-profile-card-slide]')
          const dots = slider.querySelectorAll('[data-slide-to]')
          const count = slides.length
          if (!count) return
          const nextIndex = Math.max(0, Math.min(count - 1, Number(index) || 0))
          slides.forEach((slide, idx) => {
            slide.classList.toggle('is-active', idx === nextIndex)
          })
          dots.forEach((dot) => {
            dot.classList.toggle('is-active', Number(dot.dataset.slideTo) === nextIndex)
          })
          slider.dataset.currentIndex = String(nextIndex)
        }

        function getFileSource(fileData) {
          if (!fileData) return ''
          if (typeof fileData === 'string') return fileData
          if (typeof fileData.dataUrl === 'string' && fileData.dataUrl.trim()) return fileData.dataUrl.trim()
          if (typeof fileData.downloadURL === 'string' && fileData.downloadURL.trim())
            return fileData.downloadURL.trim()
          if (typeof fileData.url === 'string' && fileData.url.trim()) return fileData.url.trim()
          if (typeof fileData.src === 'string' && fileData.src.trim()) return fileData.src.trim()
          if (typeof fileData.data === 'string' && fileData.data.trim()) {
            const data = fileData.data.trim()
            if (data.startsWith('data:')) return data
            const mime =
              typeof fileData.type === 'string' && fileData.type.trim()
                ? fileData.type.trim()
                : 'application/octet-stream'
            return `data:${mime};base64,${data}`
          }
          if (typeof fileData.base64 === 'string' && fileData.base64.trim()) {
            const mime =
              typeof fileData.type === 'string' && fileData.type.trim()
                ? fileData.type.trim()
                : 'application/octet-stream'
            return `data:${mime};base64,${fileData.base64.trim()}`
          }
          return ''
        }

        function escapeHtml(str) {
          return String(str || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
        }
      })()
    </script>
  </body>
</html>


